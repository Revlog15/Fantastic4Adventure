<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Papua - FANTASTIC4 ADVENTURE</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      #explore-info-popup {
        display: none;
        position: absolute !important;
        right: 100% !important;
        top: 0 !important;
        width: 200px !important;
        background: #2a2a2a !important;
        border: 2px solid #ffd700 !important;
        border-radius: 8px !important;
        padding: 12px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important;
        margin-right: 10px !important;
        z-index: 9999 !important;
      }

      .popup-title {
        color: #ffd700;
        font-weight: bold;
        margin-bottom: 8px;
        border-bottom: 1px solid #444;
        padding-bottom: 4px;
      }

      #explore-info-popup:after {
        content: "" !important;
        position: absolute !important;
        left: 100% !important;
        top: 15px !important;
        border-width: 8px !important;
        border-style: solid !important;
        border-color: transparent transparent transparent #ffd700 !important;
      }

      .popup-row {
        color: #eee;
        font-size: 12px;
        line-height: 1.6;
        padding: 2px 0;
      }

      .action-button.souvenirs,
      .action-button.restaurant {
        background-color: #2a2a2a;
        color: white;
        position: relative;
      }

      .info-popup {
        display: none;
        position: absolute;
        right: 100%;
        top: 0;
        width: 200px;
        background: #2a2a2a;
        border: 2px solid #00b0ff;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        margin-right: 10px;
        z-index: 9999;
      }

      .info-popup:after {
        content: "";
        position: absolute;
        left: 100%;
        top: 15px;
        border-width: 8px;
        border-style: solid;
        border-color: transparent transparent transparent #00b0ff;
      }

      .popup-title {
        color: #00b0ff;
        font-weight: bold;
        margin-bottom: 8px;
        border-bottom: 1px solid #444;
        padding-bottom: 4px;
      }

      .popup-row {
        margin: 4px 0;
        color: #fff;
      }

      .stat-change.negative {
        color: #ff4444;
      }

      .stat-change.positive {
        color: #00e676;
      }

      .stat-reward {
        color: #ffd700;
      }
    </style>
    <link rel="stylesheet" href="Papua.css" />
  </head>
  <body>
    <div class="game-container">
      <!-- Game Log on the left -->
      <div class="game-log" id="game-log">
        <div class="log-entry">[00:39] Anda memasuki PAPUA.</div>
        <div class="log-entry">
          [00:39] Jelajahi dan temukan barang berharga!
        </div>
      </div>

      <!-- Area Utama Map -->
      <div class="map-area">
        <!-- Panel Atas: Logo dan Status -->
        <div class="top-panel">
          <div class="logo">FANTASTIC4 ADVENTURE</div>
          <div class="location-title">PAPUA</div>
          <div class="status-area">
            <!-- Health Bar (Now Hunger) -->
            <div class="stat-group">
              <div class="stat-label">Hunger</div>
              <div class="stat-bar">
                <div class="stat-fill hunger" style="width: 50%"></div>
              </div>
              <div class="stat-value" id="hunger-value">50/100</div>
            </div>

            <!-- Energy Bar (Now Sleep) -->
            <div class="stat-group">
              <div class="stat-label">Sleep</div>
              <div class="stat-bar">
                <div class="stat-fill sleep" style="width: 0%"></div>
              </div>
              <div class="stat-value" id="sleep-value">0/100</div>
            </div>

            <!-- Mana Bar (Now Hygiene) -->
            <div class="stat-group">
              <div class="stat-label">Hygiene</div>
              <div class="stat-bar">
                <div class="stat-fill hygiene" style="width: 50%"></div>
              </div>
              <div class="stat-value" id="hygiene-value">50/100</div>
            </div>

            <!-- EXP Bar (Now Happiness) -->
            <div class="stat-group">
              <div class="stat-label">Happiness</div>
              <div class="stat-bar">
                <div class="stat-fill happiness" style="width: 50%"></div>
              </div>
              <div class="stat-value" id="happiness-value">50/100</div>
            </div>

            <!-- Info display area -->
            <div class="info-display">
              <!-- Money Display -->
              <div class="money-display">
                <span class="money-icon">üí∞</span>
                <span id="money-value">1260</span>
              </div>

              <!-- Game Time Display -->
              <div class="time-display">
                <span class="time-icon">üïí</span>
                <span id="game-time">00:39</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Map Game -->
        <div class="map">
          <div class="map-grid" id="game-map">
            <!-- Map tiles will be generated by JavaScript -->
          </div>
        </div>
      </div>

      <div class="action-panel">
        <!-- Back Button -->
        <button class="action-button back" id="back-to-world">
          üó∫Ô∏è Kembali ke Peta Dunia
        </button>

        <!-- Explore Button with External Info -->
        <div class="action-container">
          <button class="action-button explore" id="explore-button">
            <span class="info-icon">i</span>
            <span>üîé Eksplorasi</span>
          </button>
          <div id="explore-info-popup">
            <div class="popup-title">Exploration Details</div>
            <div class="popup-row">
              <span class="stat-change negative">-5</span> Sleep
            </div>
            <div class="popup-row">
              <span class="stat-change negative">-5</span> Hygiene
            </div>
            <div class="popup-row">
              <span class="stat-change negative">-10</span> Hunger
            </div>
            <div class="popup-row">
              <span class="stat-change positive">+25</span> Happiness
            </div>
            <div class="popup-row">
              Rewards: <span class="stat-reward">Items/Coins</span>
            </div>
          </div>
        </div>

        <!-- Buy Souvenirs Button -->
        <div class="action-container">
          <button class="action-button souvenirs" id="buy-souvenirs">
            <span class="info-icon">i</span>
            <span>üõçÔ∏è Beli Oleh-oleh</span>
          </button>
          <div id="souvenirs-info-popup" class="info-popup">
            <div class="popup-title">Souvenirs Details</div>
            <div class="popup-row">
              <span class="stat-change negative">-20</span> Money
            </div>
            <div class="popup-row">
              <span class="stat-change positive">+25</span> Happiness
            </div>
          </div>
        </div>

        <!-- Eat at Local Restaurant Button -->
        <div class="action-container">
          <button class="action-button restaurant" id="eat-local">
            <span class="info-icon">i</span>
            <span>üçΩÔ∏è Makan di Restoran Lokal</span>
          </button>
          <div id="restaurant-info-popup" class="info-popup">
            <div class="popup-title">Restaurant Details</div>
            <div class="popup-row">
              <span class="stat-change negative">-25</span> Money
            </div>
            <div class="popup-row">
              <span class="stat-change positive">+35</span> Hunger
            </div>
          </div>
        </div>

        <!-- Inventory Button -->
        <button class="action-button inventory" id="inventory-button">
          üéí Inventaris
        </button>

        <!-- Navigation Buttons -->
        <div class="navigation-buttons">
          <button class="nav-button" data-direction="up">‚¨Ü</button>
          <button class="nav-button" data-direction="left">‚¨Ö</button>
          <button class="nav-button" data-direction="down">‚¨á</button>
          <button class="nav-button" data-direction="right">‚û°</button>
        </div>
      </div>
    </div>

    <!-- Panel Inventaris -->
    <div id="inventory-panel" class="inventory-panel">
      <h2>Inventaris</h2>
      <div id="inventory-grid" class="inventory-grid"></div>
      <button id="close-inventory" class="close-inventory">Tutup</button>
    </div>

    <script>
      // Inisialisasi variabel game dari localStorage
      let gameState = {};
      let gameTimeInterval;
      let isMoving = false;
      let isActionInProgress = false;

      // Function to add log entries
      function addLogEntry(message) {
        const gameLog = document.getElementById("game-log");
        if (!gameLog) return;

        const entry = document.createElement("div");
        entry.className = "log-entry";

        // Format time
        const hours = String(gameState.gameTime.hours).padStart(2, "0");
        const minutes = String(gameState.gameTime.minutes).padStart(2, "0");

        entry.textContent = `[${hours}:${minutes}] ${message}`;

        gameLog.appendChild(entry);
        gameLog.scrollTop = gameLog.scrollHeight;
      }

      // Item untuk dikumpulkan di Papua
      const papuaItems = [
        {
          id: "papua_food",
          name: "Papeda",
          x: 2,
          y: 2,
          value: 35,
          icon: "üç≤",
          collected: false,
        },
        {
          id: "papua_weapon",
          name: "Panah Tradisional",
          x: 5,
          y: 5,
          value: 120,
          icon: "üèπ",
          collected: false,
        },
        {
          id: "papua_artifact",
          name: "Ukiran Asmat",
          x: 6,
          y: 7,
          value: 250,
          icon: "ü™µ",
          collected: false,
        },
        {
          id: "papua_clothing",
          name: "Noken",
          x: 1,
          y: 4,
          value: 80,
          icon: "üëú",
          collected: false,
        },
        {
          id: "papua_jewelry",
          name: "Perhiasan Kulit Kerang",
          x: 7,
          y: 1,
          value: 180,
          icon: "üíç",
          collected: false,
        },
      ];

      document
        .getElementById("explore-button")
        .addEventListener("mouseenter", function () {
          document.getElementById("explore-info-popup").style.display = "block";
        });

      document
        .getElementById("explore-button")
        .addEventListener("mouseleave", function () {
          document.getElementById("explore-info-popup").style.display = "none";
        });

      // Peta template Papua
      const papuaMapTemplate = [
        [
          "water",
          "water",
          "beach",
          "forest",
          "forest",
          "mountain",
          "mountain",
          "mountain",
        ],
        [
          "water",
          "beach",
          "forest",
          "forest",
          "forest",
          "forest",
          "mountain",
          "mountain",
        ],
        [
          "beach",
          "forest",
          "forest",
          "village",
          "forest",
          "forest",
          "forest",
          "mountain",
        ],
        [
          "forest",
          "forest",
          "village",
          "field",
          "field",
          "forest",
          "forest",
          "forest",
        ],
        [
          "forest",
          "field",
          "field",
          "field",
          "field",
          "field",
          "forest",
          "forest",
        ],
        [
          "mountain",
          "forest",
          "field",
          "village",
          "field",
          "forest",
          "forest",
          "mountain",
        ],
        [
          "mountain",
          "mountain",
          "forest",
          "forest",
          "forest",
          "forest",
          "mountain",
          "mountain",
        ],
        [
          "mountain",
          "mountain",
          "mountain",
          "mountain",
          "mountain",
          "mountain",
          "mountain",
          "mountain",
        ],
      ];

      // Memuat data game dari localStorage
      function loadGameState() {
        const savedState = localStorage.getItem("gameState");
        if (savedState) {
          gameState = JSON.parse(savedState);
        } else {
          // Jika tidak ada data tersimpan, inisialisasi dengan default
          gameState = {
            playerPosition: { x: 3, y: 6 }, // Posisi awal di Papua
            playerStats: {
              hunger: 50,
              maxHunger: 100,
              sleep: 0,
              maxSleep: 100,
              hygiene: 50,
              maxHygiene: 100,
              happiness: 50,
              maxHappiness: 100,
              money: 1260,
            },
            mapSize: { width: 8, height: 8 },
            gameTime: { hours: 0, minutes: 39 },
            selectedCharacter: "Revlog",
            inventory: [],
            collectedItems: {},
          };
        }

        // Set karakter dari localStorage jika ada
        const selectedChar = localStorage.getItem("selectedCharacter");
        if (selectedChar) {
          gameState.selectedCharacter = selectedChar;
        }

        // Sesuaikan format karakter untuk tampilan gambar
        gameState.selectedCharacter =
          gameState.selectedCharacter.charAt(0).toUpperCase() +
          gameState.selectedCharacter.slice(1).toLowerCase();
      }

      // Menyimpan data game ke localStorage
      function saveGameState() {
        localStorage.setItem("gameState", JSON.stringify(gameState));
      }

      // Game time update function (1 second real time = 1 minute game time)
      function startGameTime() {
        // Clear any existing interval to prevent duplicates
        if (gameTimeInterval) {
          clearInterval(gameTimeInterval);
        }

        gameTimeInterval = setInterval(() => {
          gameState.gameTime.minutes++;

          if (gameState.gameTime.minutes >= 60) {
            gameState.gameTime.hours++;
            gameState.gameTime.minutes = 0;

            // Hourly stat decreases
            updateStats("hunger", -5);
            updateStats("sleep", -3);
            updateStats("hygiene", -4);

            // Check for low stats every hour
            checkLowStats();
          }

          if (gameState.gameTime.hours >= 24) {
            gameState.gameTime.hours = 0;
          }

          updateTimeDisplay();

          // Auto-save every 10 minutes
          if (gameState.gameTime.minutes % 10 === 0) {
            saveGameState();
          }
        }, 1000); // 1 second real time = 1 minute game time
      }

      // Update time display
      function updateTimeDisplay() {
        const hours = String(gameState.gameTime.hours).padStart(2, "0");
        const minutes = String(gameState.gameTime.minutes).padStart(2, "0");
        document.getElementById(
          "game-time"
        ).textContent = `${hours}:${minutes}`;
      }

      // Add action button handler
      function handleActionButton(action) {
        if (isActionInProgress) {
          return;
        }

        isActionInProgress = true;
        playConfirmSound();

        // Perform the action
        action();

        // Reset after a longer delay to prevent double-clicks
        setTimeout(() => {
          isActionInProgress = false;
        }, 1000); // Increased from 200ms to 1000ms
      }

      // Add sound effect function
      function playConfirmSound() {
        const audio = new Audio("sounds/confirm.mp3");
        audio.volume = 0.5;
        audio.play().catch((error) => console.log("Audio play failed:", error));
      }

      // Add movement sound function
      function playMoveSound() {
        const audio = new Audio("sounds/moveandselect.mp3");
        audio.volume = 0.5;
        audio.play().catch((error) => console.log("Audio play failed:", error));
      }

      // Update movePlayer function to only use moveandselect.mp3
      function movePlayer(direction) {
        if (isMoving) {
          return;
        }

        isMoving = true;
        const audio = new Audio("sounds/moveandselect.mp3");
        audio.volume = 0.5;
        audio.play().catch((error) => console.log("Audio play failed:", error));

        let newX = gameState.playerPosition.x;
        let newY = gameState.playerPosition.y;

        switch (direction) {
          case "up":
            newY = Math.max(0, newY - 1);
            break;
          case "down":
            newY = Math.min(gameState.mapSize.height - 1, newY + 1);
            break;
          case "left":
            newX = Math.max(0, newX - 1);
            break;
          case "right":
            newX = Math.min(gameState.mapSize.width - 1, newX + 1);
            break;
        }

        if (
          newX === gameState.playerPosition.x &&
          newY === gameState.playerPosition.y
        ) {
          isMoving = false;
          return;
        }

        // Remove character from previous tile
        const prevTile = document.querySelector(".character-tile");
        if (prevTile) {
          prevTile.classList.remove("character-tile");
          const charImg = prevTile.querySelector(".character-image");
          if (charImg) charImg.remove();
        }

        // Update player position
        gameState.playerPosition.x = newX;
        gameState.playerPosition.y = newY;

        // Add character to new tile
        const newTile = document.querySelector(
          `.map-tile[data-x="${newX}"][data-y="${newY}"]`
        );
        if (newTile) {
          newTile.classList.add("character-tile");
          const charImg = document.createElement("img");
          charImg.className = "character-image";
          charImg.src = `Character/${gameState.selectedCharacter}.png`;
          newTile.appendChild(charImg);
        }

        // Update stats

        // Add log entry
        addLogEntry(`Anda bergerak ke koordinat (${newX}, ${newY}).`);

        // Check for items or events
        checkForItems(newX, newY);

        // Save game state
        saveGameState();

        setTimeout(() => {
          isMoving = false;
        }, 200);
      }

      // Generate map dengan template peta Papua
      function generateMap() {
        const mapElement = document.getElementById("game-map");
        mapElement.innerHTML = "";

        // Create map tiles based on template
        for (let y = 0; y < gameState.mapSize.height; y++) {
          for (let x = 0; x < gameState.mapSize.width; x++) {
            const tile = document.createElement("div");

            // Get terrain type from template
            const terrainType = papuaMapTemplate[y][x];

            tile.className = `map-tile terrain-${terrainType}`;

            // Set coordinates as data attributes
            tile.dataset.x = x;
            tile.dataset.y = y;

            // Check if there's a collectible item here
            const item = papuaItems.find(
              (item) => item.x === x && item.y === y
            );

            // Check if item has already been collected
            const isCollected =
              gameState.collectedItems &&
              gameState.collectedItems[`papua_${x}_${y}`];

            if (item && !isCollected) {
              const itemIcon = document.createElement("div");
              itemIcon.className = "item-icon";
              itemIcon.textContent = item.icon;
              itemIcon.dataset.itemId = item.id;
              itemIcon.dataset.tooltip = item.name;

              // Add click event directly to the item icon
              itemIcon.addEventListener("click", function (e) {
                e.stopPropagation(); // Prevent tile click
                collectItem(item);
              });

              tile.appendChild(itemIcon);
              tile.classList.add("has-item");
            }

            // Add event listener for tile click
            tile.addEventListener("click", handleTileClick);

            mapElement.appendChild(tile);

            // If this is the player's position, add the character
            if (
              x === gameState.playerPosition.x &&
              y === gameState.playerPosition.y
            ) {
              tile.classList.add("character-tile");
              const charImg = document.createElement("img");
              charImg.className = "character-image";
              charImg.src = `Character/${gameState.selectedCharacter}.png`;
              tile.appendChild(charImg);
            }
          }
        }
      }

      // Function to collect an item directly
      function collectItem(item) {
        // Check if player is on the same tile
        if (
          gameState.playerPosition.x === item.x &&
          gameState.playerPosition.y === item.y
        ) {
          // Collect the item
          if (!gameState.collectedItems) {
            gameState.collectedItems = {};
          }
          gameState.collectedItems[`papua_${item.x}_${item.y}`] = true;

          // Add to inventory
          if (!gameState.inventory) {
            gameState.inventory = [];
          }
          gameState.inventory.push({
            id: item.id,
            name: item.name,
            icon: item.icon,
            value: item.value,
            location: "PAPUA",
          });

          // Add money
          gameState.playerStats.money += item.value;

          // Add log entry
          addLogEntry(
            `Anda menemukan ${item.name}! (${item.icon}) Nilai: ${item.value} koin.`
          );

          // Update display
          updateStatusDisplay();

          // Remove item from tile
          const tile = document.querySelector(
            `.map-tile[data-x="${item.x}"][data-y="${item.y}"]`
          );
          const itemIcon = tile.querySelector(".item-icon");
          if (itemIcon) {
            itemIcon.remove();
            tile.classList.remove("has-item");
          }

          // Add happiness for finding an item
          updateStats("happiness", 10);

          // Save state
          saveGameState();
        } else {
          addLogEntry("Anda harus berada di lokasi item untuk mengambilnya.");
        }
      }

      // Update handleTileClick to not play confirm sound
      function handleTileClick(event) {
        if (isMoving) {
          return;
        }

        let target = event.target;

        // If clicked on character or item, get the parent tile
        if (
          target.classList.contains("character-image") ||
          target.classList.contains("item-icon")
        ) {
          target = target.parentElement;
        }

        const x = parseInt(target.dataset.x);
        const y = parseInt(target.dataset.y);

        // Calculate Manhattan distance to check if move is valid
        const dist =
          Math.abs(x - gameState.playerPosition.x) +
          Math.abs(y - gameState.playerPosition.y);

        if (dist <= 1) {
          movePlayer(
            x < gameState.playerPosition.x
              ? "left"
              : x > gameState.playerPosition.x
              ? "right"
              : y < gameState.playerPosition.y
              ? "up"
              : "down"
          );
        } else {
          addLogEntry("Terlalu jauh untuk bergerak langsung ke sana.");
        }
      }

      // Check for collectible items
      function checkForItems(x, y) {
        // Check for collectible item
        const item = papuaItems.find((item) => item.x === x && item.y === y);

        // Check if item has already been collected
        const isCollected =
          gameState.collectedItems &&
          gameState.collectedItems[`papua_${x}_${y}`];

        if (item && !isCollected) {
          // Add a notification about the item
          addLogEntry(
            `Ada ${item.name} di sini. Klik pada ikon ${item.icon} untuk mengambilnya.`
          );
        } else if (Math.random() < 0.1) {
          // Random event (10% chance)
          const event = Math.random();
          if (event < 0.5) {
            const coins = Math.floor(Math.random() * 10) + 2;
            gameState.playerStats.money += coins;
            addLogEntry(`Anda menemukan ${coins} koin tersembunyi!`);
            updateStatusDisplay();
          } else {
            const healAmount = Math.floor(Math.random() * 10) + 2;
            updateStats("hunger", healAmount);
            addLogEntry(
              `Anda menemukan buah-buahan liar. Hunger +${healAmount}!`
            );
          }
        }
      }

      // Update character stats
      function updateStats(stat, change) {
        const oldValue = gameState.playerStats[stat];
        const maxStat =
          gameState.playerStats[
            `max${stat.charAt(0).toUpperCase() + stat.slice(1)}`
          ];

        // Define character attributes
        const characters = {
          Revlog: {
            strength: {
              happiness: 1.5, // 50% more happiness gain
              sleep: 1.2, // 20% faster sleep recovery
            },
            weakness: {
              hunger: 1.3, // 30% faster hunger decrease
            },
          },
          Robert: {
            strength: {
              happiness: 1.5, // 50% more happiness gain
            },
            weakness: {
              hunger: 1.4, // 40% faster hunger decrease
              sleep: 1.3, // 30% faster sleep decrease
              money: 2, // Pays double for everything
            },
            special: {
              sleepPenalty: 10, // Loses 10 gold when sleeping
            },
          },
          Sam: {
            strength: {
              money: 1.5, // 50% more money from items/work
              hygiene: 1.3, // 30% slower hygiene decrease
            },
            weakness: {
              sleep: 1.4, // 40% faster sleep decrease
            },
          },
          Dimsum: {
            strength: {
              hunger: 0.7, // 30% slower hunger decrease
              money: 0.8, // 20% discount on purchases
            },
            weakness: {
              happiness: 0.7, // 30% less happiness gain
            },
          },
        };

        const char = gameState.selectedCharacter;
        const charAttrs = characters[char];

        // Apply character modifiers
        let modifiedChange = change;

        if (charAttrs) {
          // For positive changes (gains), check strengths
          if (change > 0) {
            if (charAttrs.strength && charAttrs.strength[stat]) {
              modifiedChange *= charAttrs.strength[stat];
            }
          }
          // For negative changes (costs), check weaknesses
          else if (change < 0) {
            if (charAttrs.weakness && charAttrs.weakness[stat]) {
              modifiedChange *= charAttrs.weakness[stat];
            }
          }

          // Special case for Dimsum's happiness gain
          if (char === "Dimsum" && stat === "happiness" && change > 0) {
            modifiedChange *= 0.7; // 30% less happiness gain
          }
        }

        // Round to nearest integer
        modifiedChange = Math.round(modifiedChange);

        // Calculate new value
        let newValue = oldValue + modifiedChange;
        newValue = Math.max(0, Math.min(newValue, maxStat));

        // Update the stat
        gameState.playerStats[stat] = newValue;

        // Special case for Robert's sleep penalty
        if (
          char === "Robert" &&
          stat === "sleep" &&
          newValue <= 0 &&
          charAttrs.special &&
          charAttrs.special.sleepPenalty
        ) {
          const penalty = charAttrs.special.sleepPenalty;
          gameState.playerStats.money = Math.max(
            0,
            gameState.playerStats.money - penalty
          );
          addLogEntry(`Robert kehilangan ${penalty} koin karena tertidur!`);
        }

        // Check for warnings immediately
        if (newValue <= 50) {
          const isCritical = newValue <= 30;
          showStatWarning(stat, newValue, isCritical);
        }

        // Check for game over
        if (newValue <= 0) {
          checkGameOver(stat);
        }

        // Update display
        updateStatusDisplay();

        return modifiedChange; // Return the actual change amount
      }

      function checkGameOver(stat) {
        if (gameState.playerStats[stat] <= 0) {
          const statNames = {
            hunger: "Kelaparan",
            sleep: "Kelelahan",
            hygiene: "Kebersihan",
            happiness: "Kebahagiaan",
          };

          clearInterval(gameTimeInterval);
          addLogEntry(`GAME OVER! ${statNames[stat]} Anda mencapai 0.`);
          showGameOverModal(statNames[stat]);
        }
      }

      function showGameOverModal(reason) {
        // Remove existing modal if any
        const existingModal = document.querySelector(".game-over-modal");
        if (existingModal) existingModal.remove();

        const modal = document.createElement("div");
        modal.className = "game-over-modal";
        modal.innerHTML = `
                <div class="game-over-content">
                    <h2>GAME OVER</h2>
                    <p>${reason} Anda mencapai 0!</p>
                    <p>Permainan akan direset dalam 5 detik...</p>
                    <button id="restart-button">Mulai Ulang Sekarang</button>
                </div>
            `;

        document.body.appendChild(modal);

        // Make sure modal is visible
        modal.style.display = "flex";
        modal.style.zIndex = "10000";

        // Button click handler
        document
          .getElementById("restart-button")
          .addEventListener("click", resetGame);

        // Auto-reset after 5 seconds
        setTimeout(resetGame, 5000);
      }

      function resetGame() {
        localStorage.removeItem("gameState");
        window.location.href = "CharaSelect.html"; // Change to redirect to character selection
      }

      function showStatWarning(stat, currentValue, isCritical) {
        const statNames = {
          hunger: { name: "Hunger", icon: "üî•", action: "makan" },
          sleep: { name: "Sleep", icon: "üí§", action: "tidur" },
          hygiene: { name: "Hygiene", icon: "üíß", action: "mandi" },
          happiness: { name: "Happiness", icon: "üíî", action: "hiburan" },
        };

        const message = isCritical
          ? `${statNames[stat].icon.repeat(3)} KRITIS! ${
              statNames[stat].name
            }: ${currentValue}/100 - Segera ${statNames[stat].action}!`
          : `${statNames[stat].icon} Warning! ${statNames[stat].name}: ${currentValue}/100 - Anda butuh ${statNames[stat].action}`;

        addLogEntry(message);

        // Start pulsing animation for critical
        if (isCritical) {
          const statBar = document.querySelector(`.stat-fill.${stat}`);
          statBar.style.animation = `pulse-${stat} 0.8s infinite`;
        }
      }

      // Update status display
      function updateStatusDisplay() {
        // Update all stat values
        document.getElementById(
          "hunger-value"
        ).textContent = `${gameState.playerStats.hunger}/${gameState.playerStats.maxHunger}`;
        document.getElementById(
          "sleep-value"
        ).textContent = `${gameState.playerStats.sleep}/${gameState.playerStats.maxSleep}`;
        document.getElementById(
          "hygiene-value"
        ).textContent = `${gameState.playerStats.hygiene}/${gameState.playerStats.maxHygiene}`;
        document.getElementById(
          "happiness-value"
        ).textContent = `${gameState.playerStats.happiness}/${gameState.playerStats.maxHappiness}`;

        // Update stat bars
        updateStatBar("hunger");
        updateStatBar("sleep");
        updateStatBar("hygiene");
        updateStatBar("happiness");

        // Update money display
        document.getElementById("money-value").textContent =
          gameState.playerStats.money;
      }

      function updateStatBar(stat) {
        const bar = document.querySelector(`.stat-fill.${stat}`);
        const max =
          gameState.playerStats[
            `max${stat.charAt(0).toUpperCase() + stat.slice(1)}`
          ];
        const percentage = (gameState.playerStats[stat] / max) * 100;

        // Update width and color
        bar.style.width = `${percentage}%`;

        // Handle animation
        if (gameState.playerStats[stat] <= 30) {
          bar.style.animation = `pulse-${stat} 0.8s infinite`;
        } else {
          bar.style.animation = "none";
          // Reset to original colors
          bar.style.opacity = "1";
          bar.style.boxShadow =
            stat === "hunger"
              ? "0 0 5px #ff1744"
              : stat === "sleep"
              ? "0 0 5px #ffa000"
              : stat === "hygiene"
              ? "0 0 5px #00b0ff"
              : "0 0 5px #00e676";
        }
      }

      // Fungsi inventaris
      function createInventoryPanel() {
        // Already created in HTML
        updateInventoryDisplay();
      }

      function toggleInventory(show) {
        const panel = document.getElementById("inventory-panel");
        if (!panel) return;

        panel.style.display = show ? "block" : "none";
        if (show) {
          updateInventoryDisplay();
        }
      }

      function updateInventoryDisplay() {
        const grid = document.getElementById("inventory-grid");
        if (!grid) return;

        grid.innerHTML = "";

        if (!gameState.inventory || gameState.inventory.length === 0) {
          grid.innerHTML =
            '<p style="grid-column: span 4; text-align: center; color: #aaa;">Inventaris kosong. Jelajahi lokasi untuk menemukan barang!</p>';
          return;
        }

        gameState.inventory.forEach((item) => {
          const itemElement = document.createElement("div");
          itemElement.className = "inventory-item";
          itemElement.innerHTML = `
                    <div class="inventory-item-icon">${item.icon}</div>
                    <div class="inventory-item-name">${item.name}</div>
                    <div class="inventory-item-value">${item.value} koin</div>
                `;

          // Tambahkan tooltip atau detail saat di-klik
          itemElement.addEventListener("click", () => {
            alert(
              `${item.name}\nNilai: ${item.value} koin\nDitemukan di: ${
                item.location || "Papua"
              }`
            );
          });

          grid.appendChild(itemElement);
        });
      }

      // Eksplorasi
      function exploreLocation() {
        if (gameState.playerStats.sleep >= 10) {
          updateStats("sleep", -5);
          updateStats("hunger", -10);
          updateStats("hygiene", -5);
          updateStats("happiness", 25);
          addLogEntry("Anda menjelajahi area sekitar...");

          setTimeout(() => {
            // Cari item yang belum dikumpulkan
            const uncollectedItems = papuaItems.filter((item) => {
              return (
                !gameState.collectedItems ||
                !gameState.collectedItems[`papua_${item.x}_${item.y}`]
              );
            });

            if (uncollectedItems.length > 0 && Math.random() < 0.3) {
              // Berikan petunjuk tentang item terdekat
              const playerPos = gameState.playerPosition;
              const nearestItem = uncollectedItems.reduce((nearest, item) => {
                const distCurrent =
                  Math.abs(playerPos.x - item.x) +
                  Math.abs(playerPos.y - item.y);
                const distNearest =
                  Math.abs(playerPos.x - nearest.x) +
                  Math.abs(playerPos.y - nearest.y);
                return distCurrent < distNearest ? item : nearest;
              }, uncollectedItems[0]);

              const distance =
                Math.abs(playerPos.x - nearestItem.x) +
                Math.abs(playerPos.y - nearestItem.y);

              if (distance <= 2) {
                addLogEntry(
                  "Anda merasa ada sesuatu yang menarik di dekat sini..."
                );
              } else if (distance <= 4) {
                addLogEntry(
                  "Anda merasakan ada barang berharga di sekitar area ini."
                );
              } else {
                addLogEntry(
                  "Ada sesuatu yang menarik di tempat ini, tapi tidak di dekat Anda."
                );
              }
            } else if (Math.random() < 0.5) {
              addLogEntry("Tidak ada yang menarik di sekitar sini.");
            } else {
              // Random efek eksplorasi
              const effect = Math.random();
              if (effect < 0.3) {
                const coins = Math.floor(Math.random() * 10) + 2;
                gameState.playerStats.money += coins;
                addLogEntry(`Anda menemukan ${coins} koin!`);
                updateStatusDisplay();
              } else if (effect < 0.6) {
                addLogEntry("Anda menemukan rute baru yang menarik.");
              } else {
                addLogEntry(
                  "Anda menikmati pemandangan indah di sekitar Papua."
                );
                updateStats("happiness", 5);
              }
            }
          }, 1000);
        } else {
          addLogEntry("Sleep tidak cukup untuk eksplorasi!");
        }
      }

      // Function to handle buying souvenirs
      function buySouvenirs() {
        const cost = 50; // Cost of souvenirs
        if (gameState.playerStats.money >= cost) {
          gameState.playerStats.money -= cost;
          addLogEntry(`Anda membeli oleh-oleh. Biaya: ${cost} koin.`);
          updateStatusDisplay();
        } else {
          addLogEntry("Uang tidak cukup untuk membeli oleh-oleh!");
        }
      }

      // Function to handle eating at a local restaurant
      function eatAtLocalRestaurant() {
        const cost = 30; // Cost of eating at the restaurant
        const hungerGain = 40; // Hunger gain from eating
        if (gameState.playerStats.money >= cost) {
          gameState.playerStats.money -= cost;
          updateStats("hunger", hungerGain);
          addLogEntry(
            `Anda makan di restoran lokal. Hunger +${hungerGain} (Biaya: ${cost} koin).`
          );
          updateStatusDisplay();
        } else {
          addLogEntry("Uang tidak cukup untuk makan di restoran lokal!");
        }
      }

      // Update setupEventListeners to include new buttons
      function setupEventListeners() {
        // Navigation buttons
        document.querySelectorAll(".nav-button").forEach((button) => {
          button.addEventListener("click", () => {
            if (!isMoving && !isActionInProgress) {
              const direction = button.getAttribute("data-direction");
              movePlayer(direction);
            }
          });
        });

        // Action buttons
        const exploreButton = document.querySelector(".action-button.explore");
        if (exploreButton) {
          exploreButton.addEventListener("click", () =>
            handleActionButton(exploreLocation)
          );

          // Info popup listeners
          exploreButton.addEventListener("mouseenter", function () {
            document.getElementById("explore-info-popup").style.display =
              "block";
          });

          exploreButton.addEventListener("mouseleave", function () {
            document.getElementById("explore-info-popup").style.display =
              "none";
          });
        }

        // Inventory button
        const inventoryButton = document.querySelector(
          ".action-button.inventory"
        );
        if (inventoryButton) {
          inventoryButton.addEventListener("click", () =>
            handleActionButton(() => toggleInventory(true))
          );
        }

        // Back to world button
        const backButton = document.getElementById("back-to-world");
        if (backButton) {
          backButton.addEventListener("click", () => {
            handleActionButton(() => {
              saveGameState();
              window.location.href = "MainGame.html";
            });
          });
        }

        // Close inventory button
        const closeInventoryButton = document.querySelector(".close-inventory");
        if (closeInventoryButton) {
          closeInventoryButton.addEventListener("click", () =>
            handleActionButton(() => toggleInventory(false))
          );
        }

        // Buy Souvenirs button
        const souvenirButton = document.querySelector("#buy-souvenirs");
        if (souvenirButton) {
          let lastClickTime = 0;
          souvenirButton.addEventListener("click", () => {
            const currentTime = Date.now();
            if (currentTime - lastClickTime < 1000) {
              // Prevent clicks within 1 second
              return;
            }
            lastClickTime = currentTime;
            handleActionButton(buySouvenirs);
          });

          // Add tooltip listeners
          souvenirButton.addEventListener("mouseenter", () => {
            document.getElementById("souvenirs-info-popup").style.display =
              "block";
          });
          souvenirButton.addEventListener("mouseleave", () => {
            document.getElementById("souvenirs-info-popup").style.display =
              "none";
          });
        }

        // Local Restaurant button
        const restaurantButton = document.querySelector("#eat-local");
        if (restaurantButton) {
          let lastClickTime = 0;
          restaurantButton.addEventListener("click", () => {
            const currentTime = Date.now();
            if (currentTime - lastClickTime < 1000) {
              // Prevent clicks within 1 second
              return;
            }
            lastClickTime = currentTime;
            handleActionButton(eatAtLocalRestaurant);
          });

          // Add tooltip listeners
          restaurantButton.addEventListener("mouseenter", () => {
            document.getElementById("restaurant-info-popup").style.display =
              "block";
          });
          restaurantButton.addEventListener("mouseleave", () => {
            document.getElementById("restaurant-info-popup").style.display =
              "none";
          });
        }
      }

      // Update keyboard event listener to remove sound (movePlayer will handle it)
      document.addEventListener("keydown", function (event) {
        if (!isMoving && !isActionInProgress) {
          switch (event.key) {
            case "ArrowUp":
              movePlayer("up");
              break;
            case "ArrowDown":
              movePlayer("down");
              break;
            case "ArrowLeft":
              movePlayer("left");
              break;
            case "ArrowRight":
              movePlayer("right");
              break;
            case "i":
            case "I":
              handleActionButton(() => toggleInventory(true));
              break;
            case "Escape":
              handleActionButton(() => toggleInventory(false));
              break;
          }
        }
      });

      // Initialize game
      function initGame() {
        // Load game state
        loadGameState();

        // Generate map
        generateMap();

        // Update display
        updateStatusDisplay();
        updateTimeDisplay();

        // Start game time
        startGameTime();

        // Set up event listeners
        setupEventListeners();

        // Get player name from localStorage
        const playerName = localStorage.getItem("playerName") || "Player";

        // Add initial log entry with player name
        addLogEntry(`Game dimulai dengan ${playerName}.`);
        addLogEntry(
          `Anda memasuki PAPUA dengan karakter ${gameState.selectedCharacter}.`
        );
        addLogEntry("Jelajahi dan temukan barang berharga!");
      }

      function checkLowStats() {
        // Hunger warnings
        if (gameState.playerStats.hunger <= 50) {
          const urgency =
            gameState.playerStats.hunger <= 30
              ? "üî•üî•üî• KRITIS!"
              : "üî• Warning!";
          addLogEntry(
            `${urgency} Hunger: ${gameState.playerStats.hunger}/100 - ${
              gameState.playerStats.hunger <= 30
                ? "Cari makanan segera!"
                : "Anda merasa lapar"
            }`
          );

          // Visual feedback for critical
          if (gameState.playerStats.hunger <= 30) {
            document.querySelector(".stat-fill.hunger").style.animation =
              "pulse-red 0.8s infinite";
          }
        }

        // Sleep warnings
        if (gameState.playerStats.sleep <= 50) {
          const urgency =
            gameState.playerStats.sleep <= 30
              ? "üí§üí§üí§ KRITIS!"
              : "üí§ Warning!";
          addLogEntry(
            `${urgency} Sleep: ${gameState.playerStats.sleep}/100 - ${
              gameState.playerStats.sleep <= 30
                ? "Istirahat sekarang!"
                : "Anda mengantuk"
            }`
          );

          if (gameState.playerStats.sleep <= 30) {
            document.querySelector(".stat-fill.sleep").style.animation =
              "pulse-yellow 0.8s infinite";
          }
        }

        // Hygiene warnings
        if (gameState.playerStats.hygiene <= 50) {
          const urgency =
            gameState.playerStats.hygiene <= 30
              ? "üíßüíßüíß KRITIS!"
              : "üíß Warning!";
          addLogEntry(
            `${urgency} Hygiene: ${gameState.playerStats.hygiene}/100 - ${
              gameState.playerStats.hygiene <= 30
                ? "Bersihkan diri segera!"
                : "Anda merasa kotor"
            }`
          );

          if (gameState.playerStats.hygiene <= 30) {
            document.querySelector(".stat-fill.hygiene").style.animation =
              "pulse-blue 0.8s infinite";
          }
        }

        // Happiness warnings
        if (gameState.playerStats.happiness <= 50) {
          const urgency =
            gameState.playerStats.happiness <= 30
              ? "üíîüíîüíî KRITIS!"
              : "üíî Warning!";
          addLogEntry(
            `${urgency} Happiness: ${gameState.playerStats.happiness}/100 - ${
              gameState.playerStats.happiness <= 30
                ? "Lakukan sesuatu yang menyenangkan!"
                : "Anda merasa tidak bahagia"
            }`
          );

          if (gameState.playerStats.happiness <= 30) {
            document.querySelector(".stat-fill.happiness").style.animation =
              "pulse-green 0.8s infinite";
          }
        }
      }

      // Run game when page loads
      window.onload = initGame;
    </script>
  </body>
</html>
