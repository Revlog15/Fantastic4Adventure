<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Adventure</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      #explore-info-popup {
        display: none;
        position: absolute !important;
        right: 100% !important;
        top: 0 !important;
        width: 200px !important;
        background: #2a2a2a !important;
        border: 2px solid #ffd700 !important;
        border-radius: 8px !important;
        padding: 12px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important;
        margin-right: 10px !important;
        z-index: 9999 !important;
      }

      /* Arrow pointing from popup to button */
      #explore-info-popup:after {
        content: "" !important;
        position: absolute !important;
        left: 100% !important;
        top: 15px !important;
        border-width: 8px !important;
        border-style: solid !important;
        border-color: transparent transparent transparent #ffd700 !important;
      }

      .info-popup {
        display: none;
        position: absolute;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 10px;
        border-radius: 4px;
        font-size: 14px;
        width: max-content;
        max-width: 200px;
        z-index: 1000;
        border: 1px solid gold;
        left: -1750%;
        top: 700%;
        transform: translateY(-50%);
        margin-left: 8px;
        white-space: pre-line;
      }

      .info-icon:hover .info-popup {
        display: block;
      }

      .greeting-display {
        position: absolute;
        top: 65px;
        right: 20px;
        background-color: rgba(0, 30, 60, 0.4);
        color: #ffffff;
        padding: 8px 15px;
        font-size: 16px;
        font-weight: bold;
        z-index: 1000;
        text-align: center;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        white-space: nowrap;
        border: 2px solid #00b0ff;
        border-radius: 5px;
        box-shadow: 0 0 0 1px white, 0 0 10px rgba(0, 176, 255, 0.5);
      }

      .info-display {
        position: relative;
        display: flex;
        align-items: flex-start;
        gap: 20px;
        margin-left: auto;
        padding-top: 5px;
      }
    </style>
    <link rel="stylesheet" href="MainGame.css" />
  </head>
  <body>
    <div class="game-container">
      <div class="game-log" id="game-log">
        <div class="log-entry">[00:22] Anda menemukan 10 koin!</div>
        <div class="log-entry">[00:23] Anda bergerak ke koordinat (6, 2).</div>
        <div class="log-entry">[00:25] Anda bergerak ke koordinat (5, 2).</div>
        <div class="log-entry">[00:25] Anda bergerak ke koordinat (4, 2).</div>
      </div>
      <!-- Area Utama Map -->
      <div class="map-area">
        <!-- Panel Atas: Logo dan Status -->
        <div class="top-panel">
          <div class="logo">FANTASTIC4 ADVENTURE</div>
          <div class="status-area">
            <!-- Health Bar (Now Hunger) -->
            <div class="stat-group">
              <div class="stat-label">Hunger</div>
              <div class="stat-bar">
                <div class="stat-fill hunger" style="width: 50%"></div>
              </div>
              <div class="stat-value" id="hunger-value">50/100</div>
            </div>

            <!-- Energy Bar (Now Sleep) -->
            <div class="stat-group">
              <div class="stat-label">Sleep</div>
              <div class="stat-bar">
                <div class="stat-fill sleep" style="width: 0%"></div>
              </div>
              <div class="stat-value" id="sleep-value">50/100</div>
            </div>

            <!-- Mana Bar (Now Hygiene) -->
            <div class="stat-group">
              <div class="stat-label">Hygiene</div>
              <div class="stat-bar">
                <div class="stat-fill hygiene" style="width: 50%"></div>
              </div>
              <div class="stat-value" id="hygiene-value">50/100</div>
            </div>

            <!-- EXP Bar (Now Happiness) -->
            <div class="stat-group">
              <div class="stat-label">Happiness</div>
              <div class="stat-bar">
                <div class="stat-fill happiness" style="width: 50%"></div>
              </div>
              <div class="stat-value" id="happiness-value">50/100</div>
            </div>

            <!-- Info display area -->
            <div class="info-display">
              <!-- Money Display -->
              <div class="money-display">
                <span class="money-icon">üí∞</span>
                <span id="money-value">1260</span>
              </div>

              <!-- Game Time Display -->
              <div class="time-display">
                <span class="time-icon">üïí</span>
                <span id="game-time">00:39</span>
              </div>

              <!-- Greeting Display -->
              <div id="greeting-display" class="greeting-display"></div>
            </div>
          </div>
        </div>

        <!-- Map Game -->
        <div class="map">
          <div class="map-grid" id="game-map">
            <!-- Map tiles will be generated by JavaScript -->
          </div>
        </div>

        <!-- Game Log -->
      </div>

      <!-- Panel Kanan dengan Tombol-tombol Aksi -->
      <div class="action-panel">
        <button class="action-button location-specific explore">
          <span class="info-icon" data-tooltip="Cost: -15 Happiness">i</span>
          üîé Eksplorasi
        </button>
        <button class="action-button location-specific home-eat">
          <span
            class="info-icon"
            data-tooltip="Cost: 20 coins&#10;Effect: +35 Hunger"
            >i</span
          >
          üç≤ Makan
        </button>

        <button class="action-button location-specific home-bath">
          üöø Mandi
        </button>
        <button class="action-button location-specific home-sleep">
          üõå Tidur
        </button>
        <button class="action-button location-specific home-work">
          <span
            class="info-icon"
            data-tooltip="Earnings: 50-150 coins&#10;Cost: -20 Sleep, -20 Hunger -35 hygiene"
            >i</span
          >
          üíº Bekerja
        </button>
        <button class="action-button location-specific home-games">
          <span
            class="info-icon"
            data-tooltip="Effect: +50 Happiness&#10;Cost: -25 Sleep"
            >i</span
          >
          üéÆ Main Game
        </button>
        <button class="action-button inventory">üéí Inventaris</button>

        <!-- Tombol Navigasi di panel kanan -->
        <div class="navigation-buttons">
          <button class="nav-button" data-direction="up">‚¨Ü</button>
          <button class="nav-button" data-direction="left">‚¨Ö</button>
          <button class="nav-button" data-direction="down">‚¨á</button>
          <button class="nav-button" data-direction="right">‚û°</button>
        </div>
      </div>
    </div>

    <script>
      // Inisialisasi variabel game
      const gameState = {
        playerPosition: { x: 3, y: 3 },
        playerStats: {
          hunger: 50,
          maxHunger: 100,
          sleep: 50, // Changed to match screenshot
          maxSleep: 100,
          hygiene: 50,
          maxHygiene: 100,
          happiness: 50,
          maxHappiness: 100,
          money: 500,
        },
        mapSize: { width: 8, height: 8 },
        gameTime: { hours: 0, minutes: 39 }, // Set to match screenshot
        selectedCharacter: "",
      };

      // First, let's fix the characters object to be more precise
      const characters = {
        Revlog: {
          strength: {
            happiness: 1.5, // 50% more happiness gain
            sleep: 1.2, // 20% faster sleep recovery
          },
          weakness: {
            hunger: 1.3, // 30% faster hunger decrease
          },
        },
        Robert: {
          strength: {
            happiness: 1.5, // 50% more happiness gain
          },
          weakness: {
            hunger: 1.4, // 40% faster hunger decrease
            sleep: 1.3, // 30% faster sleep decrease
            money: 2, // Pays double for everything (represented as multiplier)
          },
          special: {
            sleepPenalty: 10, // Loses 10 gold when sleeping
          },
        },
        Sam: {
          strength: {
            money: 1.5, // 50% more money from items/work
            hygiene: 1.3, // 30% slower hygiene decrease
          },
          weakness: {
            sleep: 1.4, // 40% faster sleep decrease
          },
        },
        Dimsum: {
          strength: {
            hunger: 0.7, // 30% slower hunger decrease
            money: 0.5, // 50% discount on purchases
          },
          weakness: {
            happiness: 0.7, // 30% less happiness gain
          },
        },
      };

      // Add this variable to track movement state
      let isMoving = false;
      let isActionInProgress = false;

      // Update movePlayer function to only use moveandselect.mp3
      function movePlayer(direction) {
        if (isMoving) {
          return;
        }

        isMoving = true;
        const audio = new Audio("sounds/moveandselect.mp3");
        audio.volume = 0.5;
        audio.play().catch((error) => console.log("Audio play failed:", error));

        let newX = gameState.playerPosition.x;
        let newY = gameState.playerPosition.y;

        switch (direction) {
          case "up":
            newY = Math.max(0, newY - 1);
            break;
          case "down":
            newY = Math.min(gameState.mapSize.height - 1, newY + 1);
            break;
          case "left":
            newX = Math.max(0, newX - 1);
            break;
          case "right":
            newX = Math.min(gameState.mapSize.width - 1, newX + 1);
            break;
        }

        // If position didn't change, do nothing
        if (
          newX === gameState.playerPosition.x &&
          newY === gameState.playerPosition.y
        ) {
          isMoving = false;
          return;
        }

        // Remove character from previous tile
        const prevTile = document.querySelector(".character-tile");
        if (prevTile) {
          prevTile.classList.remove("character-tile");
          const charImg = prevTile.querySelector(".character-image");
          if (charImg) charImg.remove();
        }

        // Update player position
        gameState.playerPosition.x = newX;
        gameState.playerPosition.y = newY;

        // Add character to new tile
        const newTile = document.querySelector(
          `.map-tile[data-x="${newX}"][data-y="${newY}"]`
        );
        if (newTile) {
          newTile.classList.add("character-tile");
          const charImg = document.createElement("img");
          charImg.className = "character-image";
          charImg.src = `Character/${gameState.selectedCharacter}.png`;
          newTile.appendChild(charImg);
        }

        // Update location-specific buttons
        updateLocationButtons(newX, newY);

        // Add log entry
        addLogEntry(`Anda bergerak ke koordinat (${newX}, ${newY}).`);

        // Check for events
        checkForEvents(newX, newY);

        // Save game state
        saveGameState();

        setTimeout(() => {
          isMoving = false;
        }, 200);
      }

      // Update handleTileClick to not play confirm sound
      function handleTileClick(event) {
        if (isMoving) {
          return;
        }

        let target = event.target;

        // If clicked on character or item, get the parent tile
        if (
          target.classList.contains("character-image") ||
          target.classList.contains("item-icon")
        ) {
          target = target.parentElement;
        }

        const x = parseInt(target.dataset.x);
        const y = parseInt(target.dataset.y);

        // Calculate Manhattan distance to check if move is valid
        const dist =
          Math.abs(x - gameState.playerPosition.x) +
          Math.abs(y - gameState.playerPosition.y);

        if (dist <= 1) {
          movePlayer(
            x < gameState.playerPosition.x
              ? "left"
              : x > gameState.playerPosition.x
              ? "right"
              : y < gameState.playerPosition.y
              ? "up"
              : "down"
          );
        } else {
          addLogEntry("Terlalu jauh untuk bergerak langsung ke sana.");
        }
      }

      function updateLocationButtons(x, y) {
        // Hide all location-specific buttons first
        document
          .querySelectorAll(".action-button.location-specific")
          .forEach((btn) => {
            btn.style.display = "none";
          });

        // Check if player is at a special location
        const specialLocations = [
          { name: "home", x: 1, y: 1 },
          { name: "jakarta", x: 6, y: 1 },
          { name: "padang", x: 1, y: 6 },
          { name: "magelang", x: 6, y: 6 },
          { name: "papua", x: 3, y: 3 },
        ];

        const currentLocation = specialLocations.find(
          (loc) => loc.x === x && loc.y === y
        );

        if (currentLocation) {
          if (currentLocation.name === "home") {
            // Show home-specific buttons including games
            document
              .querySelectorAll(
                ".action-button.home-eat, .action-button.home-bath, .action-button.home-sleep, .action-button.home-work, .action-button.home-games"
              )
              .forEach((btn) => {
                btn.style.display = "block";
              });
          } else {
            // Show explore button for other locations
            document.querySelector(
              ".action-button.location-specific.explore"
            ).style.display = "block";
          }
        }
      }

      // Generate map with special locations
      function generateMap() {
        const mapElement = document.getElementById("game-map");
        mapElement.innerHTML = "";

        // Define special locations
        const specialLocations = [
          { name: "home", x: 1, y: 1 },
          { name: "jakarta", x: 6, y: 1 },
          { name: "padang", x: 1, y: 6 },
          { name: "magelang", x: 6, y: 6 },
          { name: "papua", x: 3, y: 3 },
        ];

        // Create map tiles
        for (let y = 0; y < gameState.mapSize.height; y++) {
          for (let x = 0; x < gameState.mapSize.width; x++) {
            const tile = document.createElement("div");

            // Check if this is a special location
            const specialLocation = specialLocations.find(
              (loc) => loc.x === x && loc.y === y
            );

            if (specialLocation) {
              tile.className = `map-tile special-location ${specialLocation.name}`;
              tile.dataset.location = specialLocation.name.toUpperCase();
            } else {
              tile.className = "map-tile";
            }

            // Set coordinates as data attributes
            tile.dataset.x = x;
            tile.dataset.y = y;

            // Add event listener for tile click
            tile.addEventListener("click", handleTileClick);

            mapElement.appendChild(tile);

            // If this is the player's position, add the character
            if (
              x === gameState.playerPosition.x &&
              y === gameState.playerPosition.y
            ) {
              tile.classList.add("character-tile");
              const charImg = document.createElement("img");
              charImg.className = "character-image";
              charImg.src = `Character/${gameState.selectedCharacter}.png`;
              tile.appendChild(charImg);
            }
          }
        }
      }

      // Update character stats
      function updateStats(stat, change) {
        const oldValue = gameState.playerStats[stat];
        const maxStat =
          gameState.playerStats[
            `max${stat.charAt(0).toUpperCase() + stat.slice(1)}`
          ];
        const char = gameState.selectedCharacter;
        const charAttrs = characters[char];

        // Apply character modifiers
        let modifiedChange = change;

        if (charAttrs) {
          // For positive changes (gains), apply strength multiplier
          if (change > 0 && charAttrs.strength && charAttrs.strength[stat]) {
            modifiedChange = Math.round(change * charAttrs.strength[stat]);
          }
          // For negative changes (costs), apply weakness multiplier
          else if (
            change < 0 &&
            charAttrs.weakness &&
            charAttrs.weakness[stat]
          ) {
            modifiedChange = Math.round(
              change * (1 / charAttrs.weakness[stat])
            );
          }
          // For negative changes with strength, reduce the penalty
          else if (
            change < 0 &&
            charAttrs.strength &&
            charAttrs.strength[stat]
          ) {
            modifiedChange = Math.round(
              change * (1 / charAttrs.strength[stat])
            );
          }
        }

        // Calculate new value
        let newValue = oldValue + modifiedChange;
        newValue = Math.max(0, Math.min(newValue, maxStat));

        // Update the stat
        gameState.playerStats[stat] = newValue;

        // Special case for Robert's sleep penalty
        if (
          char === "Robert" &&
          stat === "sleep" &&
          newValue <= 0 &&
          charAttrs.special &&
          charAttrs.special.sleepPenalty
        ) {
          const penalty = charAttrs.special.sleepPenalty;
          gameState.playerStats.money = Math.max(
            0,
            gameState.playerStats.money - penalty
          );
          addLogEntry(`Robert kehilangan ${penalty} koin karena tertidur!`);
        }

        // Check for warnings
        if (newValue <= 50) {
          const isCritical = newValue <= 30;
          showStatWarning(stat, newValue, isCritical);
        }

        // Check for game over
        if (newValue <= 0) {
          checkGameOver(stat);
        }

        // Update display
        updateStatusDisplay();

        return modifiedChange; // Return the actual change applied
      }

      function showStatWarning(stat, currentValue, isCritical) {
        const statNames = {
          hunger: { name: "Hunger", icon: "üî•", action: "makan" },
          sleep: { name: "Sleep", icon: "üí§", action: "tidur" },
          hygiene: { name: "Hygiene", icon: "üíß", action: "mandi" },
          happiness: { name: "Happiness", icon: "üíî", action: "hiburan" },
        };

        const message = isCritical
          ? `${statNames[stat].icon.repeat(3)} KRITIS! ${
              statNames[stat].name
            }: ${currentValue}/100 - Segera ${statNames[stat].action}!`
          : `${statNames[stat].icon} Warning! ${statNames[stat].name}: ${currentValue}/100 - Anda butuh ${statNames[stat].action}`;

        addLogEntry(message);
      }

      // Add this new function to check for game over
      function checkGameOver(stat) {
        if (gameState.playerStats[stat] <= 0) {
          const statNames = {
            hunger: "Kelaparan",
            sleep: "Kelelahan",
            hygiene: "Kebersihan",
            happiness: "Kebahagiaan",
          };

          clearInterval(gameTimeInterval);
          addLogEntry(`GAME OVER! ${statNames[stat]} Anda mencapai 0.`);
          showGameOverModal(statNames[stat]);
        }
      }

      function showGameOverModal(reason) {
        // Remove existing modal if any
        const existingModal = document.querySelector(".game-over-modal");
        if (existingModal) existingModal.remove();

        const modal = document.createElement("div");
        modal.className = "game-over-modal";
        modal.innerHTML = `
        <div class="game-over-content">
            <h2>GAME OVER</h2>
            <p>${reason} Anda mencapai 0!</p>
            <p>Permainan akan direset dalam 5 detik...</p>
            <button id="restart-button">Mulai Ulang Sekarang</button>
        </div>
    `;

        document.body.appendChild(modal);

        // Make sure modal is visible
        modal.style.display = "flex";
        modal.style.zIndex = "10000";

        // Button click handler
        const restartButton = document.getElementById("restart-button");
        if (restartButton) {
          restartButton.addEventListener("click", () => {
            localStorage.removeItem("gameState");
            window.location.href = "CharaSelect.html";
          });
        }

        // Auto-reset after 5 seconds
        setTimeout(() => {
          localStorage.removeItem("gameState");
          window.location.href = "CharaSelect.html";
        }, 5000);
      }

      // Don't forget to declare the gameTimeInterval at the top
      let gameTimeInterval; // Declare at the top with other variables

      // Add function to get time-based greeting
      function getTimeBasedGreeting() {
        const hours = gameState.gameTime.hours;
        const playerName = localStorage.getItem("playerName") || "Player";

        if (hours >= 5 && hours < 12) {
          return `Selamat Pagi, ${playerName}!`;
        } else if (hours >= 12 && hours < 15) {
          return `Selamat Siang, ${playerName}!`;
        } else if (hours >= 15 && hours < 18) {
          return `Selamat Sore, ${playerName}!`;
        } else {
          return `Selamat Malam, ${playerName}!`;
        }
      }

      // Add function to update greeting display
      function updateGreetingDisplay() {
        const greetingDisplay = document.getElementById("greeting-display");
        if (greetingDisplay) {
          greetingDisplay.textContent = getTimeBasedGreeting();
        }
      }

      // Update startGameTime to use the fixed greeting display
      function startGameTime() {
        // Clear any existing interval to prevent duplicates
        if (gameTimeInterval) {
          clearInterval(gameTimeInterval);
        }

        gameTimeInterval = setInterval(() => {
          const oldHours = gameState.gameTime.hours;
          gameState.gameTime.minutes++;

          if (gameState.gameTime.minutes >= 60) {
            gameState.gameTime.hours++;
            gameState.gameTime.minutes = 0;

            // Hourly stat decreases
            updateStats("hunger", -5);
            updateStats("sleep", -3);
            updateStats("hygiene", -4);

            // Check for low stats every hour
            checkLowStats();
          }

          if (gameState.gameTime.hours >= 24) {
            gameState.gameTime.hours = 0;
          }

          // Check if we crossed a greeting boundary
          const newHours = gameState.gameTime.hours;
          if (
            (oldHours < 5 && newHours >= 5) ||
            (oldHours < 12 && newHours >= 12) ||
            (oldHours < 15 && newHours >= 15) ||
            (oldHours < 18 && newHours >= 18) ||
            (oldHours === 23 && newHours === 0)
          ) {
            updateGreetingDisplay();
          }

          updateTimeDisplay();

          // Auto-save every 10 minutes
          if (gameState.gameTime.minutes % 10 === 0) {
            saveGameState();
          }
        }, 1000); // 1 second real time = 1 minute game time
      }

      // Update time display
      function updateTimeDisplay() {
        const hours = String(gameState.gameTime.hours).padStart(2, "0");
        const minutes = String(gameState.gameTime.minutes).padStart(2, "0");
        document.getElementById(
          "game-time"
        ).textContent = `${hours}:${minutes}`;
      }

      // Update status display
      function updateStatusDisplay() {
        // Update all stat values
        document.getElementById(
          "hunger-value"
        ).textContent = `${gameState.playerStats.hunger}/${gameState.playerStats.maxHunger}`;
        document.getElementById(
          "sleep-value"
        ).textContent = `${gameState.playerStats.sleep}/${gameState.playerStats.maxSleep}`;
        document.getElementById(
          "hygiene-value"
        ).textContent = `${gameState.playerStats.hygiene}/${gameState.playerStats.maxHygiene}`;
        document.getElementById(
          "happiness-value"
        ).textContent = `${gameState.playerStats.happiness}/${gameState.playerStats.maxHappiness}`;

        // Update stat bars
        updateStatBar("hunger");
        updateStatBar("sleep");
        updateStatBar("hygiene");
        updateStatBar("happiness");

        // Update money display
        document.getElementById("money-value").textContent =
          gameState.playerStats.money;
      }

      function updateStatBar(stat) {
        const bar = document.querySelector(`.stat-fill.${stat}`);
        const max =
          gameState.playerStats[
            `max${stat.charAt(0).toUpperCase() + stat.slice(1)}`
          ];
        const percentage = (gameState.playerStats[stat] / max) * 100;

        // Update width and color
        bar.style.width = `${percentage}%`;

        // Handle animation
        if (gameState.playerStats[stat] <= 30) {
          bar.style.animation = `pulse-${stat} 0.8s infinite`;
        } else {
          bar.style.animation = "none";
          // Reset to original colors
          bar.style.opacity = "1";
          bar.style.boxShadow =
            stat === "hunger"
              ? "0 0 5px #ff1744"
              : stat === "sleep"
              ? "0 0 5px #ffa000"
              : stat === "hygiene"
              ? "0 0 5px #00b0ff"
              : "0 0 5px #00e676";
        }
      }

      // Add log entry
      function addLogEntry(message) {
        const logElement = document.getElementById("game-log");
        const entry = document.createElement("div");
        entry.className = "log-entry";

        // Add timestamp to log entries
        const hours = String(gameState.gameTime.hours).padStart(2, "0");
        const minutes = String(gameState.gameTime.minutes).padStart(2, "0");
        entry.textContent = `[${hours}:${minutes}] ${message}`;

        logElement.appendChild(entry);

        // Auto-scroll to latest entry
        logElement.scrollTop = logElement.scrollHeight;

        // Limit number of entries (optional)
        if (logElement.children.length > 20) {
          logElement.removeChild(logElement.children[0]);
        }
      }

      // Check for special events on tiles
      // Tambahkan fungsi berikut ke MainGame.html untuk navigasi ke lokasi

      // Fungsi untuk mengecek special events dan menambahkan navigasi ke lokasi tertentu
      function checkForEvents(x, y) {
        // Special locations for 8x8 grid
        const specialLocations = [
          { name: "HOME", x: 1, y: 1, file: "Home.html" },
          { name: "JAKARTA", x: 6, y: 1, file: "Jakarta.html" },
          { name: "PADANG", x: 1, y: 6, file: "Padang.html" },
          { name: "MAGELANG", x: 6, y: 6, file: "Magelang.html" },
          { name: "PAPUA", x: 3, y: 3, file: "Papua.html" },
        ];

        const locationMessages = {
          HOME: "üè† Home sweet home! Gunakan tombol aksi untuk makan, mandi, atau tidur.",
          JAKARTA:
            "üèôÔ∏è Selamat datang di Jakarta! Jelajahi Monas dan keramaian kota.",
          PADANG: "üåã Masuki tanah Minang! Jangan lupa cicipi rendangnya.",
          MAGELANG:
            "üõï Anda dekat dengan Candi Borobudur. Ambil foto yang epik!",
          PAPUA: "üå¥ Datanglah ke Honai! Nikmati alam Papua yang mempesona.",
        };

        const specialLocation = specialLocations.find(
          (loc) => loc.x === x && loc.y === y
        );
        if (specialLocation) {
          // Gunakan pesan custom jika ada, jika tidak pakai pesan default
          const customMessage =
            locationMessages[specialLocation.name] ||
            `Anda tiba di ${specialLocation.name}.`;
          addLogEntry(customMessage);

          // Time-specific events
          const hour = gameState.gameTime.hours;
          if (hour >= 22 || hour < 6) {
            addLogEntry("Sudah malam hari. Waktunya beristirahat.");
          }
        } else if (Math.random() < 0.2) {
          // Random event logic (unchanged)
          const event = Math.random();
          if (event < 0.4) {
            const coins = Math.floor(Math.random() * 20) + 5;
            gameState.playerStats.money += coins;
            addLogEntry(`Anda menemukan ${coins} koin!`);
            updateStatusDisplay();
          } else if (event < 0.7) {
            addLogEntry("Anda menemukan sebuah item.");
          } else if (event < 0.9) {
            addLogEntry("Anda diserang musuh! Bersiaplah untuk pertempuran!");
          } else {
            const healAmount = Math.floor(Math.random() * 20) + 5;
            updateStats("hunger", healAmount);
            addLogEntry(
              `Anda menemukan mata air penyembuhan. Hunger +${healAmount}!`
            );
          }
        }
      }

      // Fungsi untuk menyimpan status game
      function saveGameState() {
        const gameStateData = {
          playerPosition: gameState.playerPosition,
          playerStats: gameState.playerStats,
          mapSize: gameState.mapSize,
          gameTime: gameState.gameTime,
          selectedCharacter: gameState.selectedCharacter,
          inventory: gameState.inventory || [],
          collectedItems: gameState.collectedItems || {},
        };

        localStorage.setItem("gameState", JSON.stringify(gameStateData));
      }

      // Fungsi untuk memuat status game
      function loadGameState() {
        const savedState = localStorage.getItem("gameState");
        if (savedState) {
          const parsedState = JSON.parse(savedState);

          // Update gameState dengan data yang disimpan
          if (parsedState.playerStats)
            gameState.playerStats = parsedState.playerStats;
          if (parsedState.gameTime) gameState.gameTime = parsedState.gameTime;
          if (parsedState.inventory)
            gameState.inventory = parsedState.inventory;
          if (parsedState.collectedItems)
            gameState.collectedItems = parsedState.collectedItems;

          // Jika kembali dari lokasi, gunakan posisi yang tersimpan
          // Jika pertama kali main, gunakan posisi default
          if (parsedState.playerPosition) {
            gameState.playerPosition = parsedState.playerPosition;
          }
        }

        // Set karakter dari localStorage
        const selectedChar = localStorage.getItem("selectedCharacter");
        if (selectedChar) {
          gameState.selectedCharacter = selectedChar;
          // Log selected character for debugging
          console.log("Selected character:", gameState.selectedCharacter);
          // Verify character exists in the characters object
          console.log(
            "Character exists in characters object:",
            characters.hasOwnProperty(gameState.selectedCharacter)
          );
        } else {
          // Default to Revlog if no character selected
          gameState.selectedCharacter = "Revlog";
          console.log(
            "No character selected, defaulting to:",
            gameState.selectedCharacter
          );
        }

        // Log the characters object keys for debugging
        console.log("Available character keys:", Object.keys(characters));
      }

      // Update initGame to show initial greeting
      function initGame() {
        // Load game state
        loadGameState();

        // Generate map
        generateMap();

        // Update display
        updateStatusDisplay();
        updateTimeDisplay();
        updateGreetingDisplay(); // Add initial greeting

        // Start game time
        startGameTime();

        // Set up event listeners
        setupEventListeners();
      }

      // Tambahkan fungsi ini untuk menampilkan inventaris
      function createInventoryPanel() {
        // Check if panel doesn't exist yet
        if (!document.getElementById("inventory-panel")) {
          const inventoryPanel = document.createElement("div");
          inventoryPanel.id = "inventory-panel";
          inventoryPanel.className = "inventory-panel";

          inventoryPanel.innerHTML = `
            <h2>Inventaris</h2>
            <div id="inventory-grid" class="inventory-grid"></div>
            <button class="close-inventory" onclick="toggleInventory(false)">Tutup</button>
        `;

          document.body.appendChild(inventoryPanel);
        }
      }

      // Fungsi untuk toggle inventaris
      function toggleInventory(show) {
        const panel = document.getElementById("inventory-panel");
        if (!panel && show) {
          createInventoryPanel();
          updateInventoryDisplay();
          document.getElementById("inventory-panel").style.display = "block";
        } else if (panel) {
          panel.style.display = show ? "block" : "none";
          if (show) {
            updateInventoryDisplay();
          }
        }
      }

      // Fungsi untuk update inventaris
      function updateInventoryDisplay() {
        const grid = document.getElementById("inventory-grid");
        if (!grid) return;

        grid.innerHTML = "";

        if (!gameState.inventory || gameState.inventory.length === 0) {
          grid.innerHTML =
            '<p style="grid-column: span 4; text-align: center; color: #aaa;">Inventaris kosong. Jelajahi lokasi untuk menemukan barang!</p>';
          return;
        }

        gameState.inventory.forEach((item) => {
          const itemElement = document.createElement("div");
          itemElement.className = "inventory-item";
          itemElement.innerHTML = `
            <div class="inventory-item-icon">${item.icon}</div>
            <div class="inventory-item-name">${item.name}</div>
            <div class="inventory-item-value">${item.value} koin</div>
        `;

          // Tambahkan tooltip atau detail saat di-klik
          itemElement.addEventListener("click", () => {
            alert(
              `${item.name}\nNilai: ${item.value} koin\nDitemukan di: ${
                item.location || "Unknown"
              }`
            );
          });

          grid.appendChild(itemElement);
        });
      }

      // Update event listener untuk tombol inventory
      document.addEventListener("DOMContentLoaded", () => {
        // Event listeners untuk tombol inventaris
        const inventoryButton = document.querySelector(
          ".action-button.inventory"
        );
        if (inventoryButton) {
          inventoryButton.addEventListener("click", () => {
            toggleInventory(true);
          });
        }

        // Event listener untuk tombol escape
        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape") {
            toggleInventory(false);
          } else if (event.key === "i" || event.key === "I") {
            toggleInventory(true);
          }
        });
      });

      // Tambahkan event listener untuk tombol navigasi saat DOM loaded
      document.addEventListener("DOMContentLoaded", function () {
        // Set up arrow buttons
        document.querySelectorAll(".nav-button").forEach((button) => {
          button.addEventListener("click", function () {
            if (!isMoving) {
              const direction = this.getAttribute("data-direction");
              movePlayer(direction);
            }
          });
        });

        // Set up explore button to handle city exploration
        document
          .querySelector(".action-button.explore")
          .addEventListener("click", function () {
            exploreOrEnterCity();
          });

        // Set up inventory button
        document
          .querySelector(".action-button.inventory")
          .addEventListener("click", function () {
            toggleInventory(true);
          });

        // Set up other action buttons
        setupActionButtons();
      });

      // Add this function to handle action button clicks
      function handleActionButton(action) {
        if (isActionInProgress) {
          return;
        }

        isActionInProgress = true;
        const audio = new Audio("sounds/confirm.mp3");
        audio.volume = 0.5;
        audio.play().catch((error) => console.log("Audio play failed:", error));

        // Perform the action
        action();

        // Reset after a short delay
        setTimeout(() => {
          isActionInProgress = false;
        }, 200);
      }

      // Update setupActionButtons to remove sound (movePlayer will handle it)
      function setupActionButtons() {
        // Navigation buttons
        document.querySelectorAll(".nav-button").forEach((button) => {
          button.addEventListener("click", () => {
            if (!isMoving && !isActionInProgress) {
              const direction = button.getAttribute("data-direction");
              movePlayer(direction);
            }
          });
        });

        // Home actions
        const eatButton = document.querySelector(".action-button.home-eat");
        if (eatButton) {
          eatButton.addEventListener("click", () => handleActionButton(eat));
        }

        const bathButton = document.querySelector(".action-button.home-bath");
        if (bathButton) {
          bathButton.addEventListener("click", () =>
            handleActionButton(shower)
          );
        }

        const sleepButton = document.querySelector(".action-button.home-sleep");
        if (sleepButton) {
          sleepButton.addEventListener("click", () =>
            handleActionButton(sleep)
          );
        }

        const workButton = document.querySelector(".action-button.home-work");
        if (workButton) {
          workButton.addEventListener("click", () => handleActionButton(work));
        }

        // Explore button
        const exploreButton = document.querySelector(
          ".action-button.location-specific.explore"
        );
        if (exploreButton) {
          exploreButton.addEventListener("click", () =>
            handleActionButton(exploreOrEnterCity)
          );
        }

        // Inventory button
        const inventoryButton = document.querySelector(
          ".action-button.inventory"
        );
        if (inventoryButton) {
          inventoryButton.addEventListener("click", () =>
            handleActionButton(() => toggleInventory(true))
          );
        }

        // Close inventory button
        const closeInventoryButton = document.querySelector(".close-inventory");
        if (closeInventoryButton) {
          closeInventoryButton.addEventListener("click", () =>
            handleActionButton(() => toggleInventory(false))
          );
        }

        // Back to world button
        const backButton = document.getElementById("back-to-world");
        if (backButton) {
          backButton.addEventListener("click", () => {
            handleActionButton(() => {
              saveGameState();
              window.location.href = "MainGame.html";
            });
          });
        }

        // Add Play Games button
        const gamesButton = document.querySelector(".action-button.home-games");
        if (gamesButton) {
          gamesButton.addEventListener("click", () =>
            handleActionButton(playGames)
          );
        }
      }

      // Update keyboard event listener to remove sound (movePlayer will handle it)
      document.addEventListener("keydown", function (event) {
        if (!isMoving && !isActionInProgress) {
          switch (event.key) {
            case "ArrowUp":
              movePlayer("up");
              break;
            case "ArrowDown":
              movePlayer("down");
              break;
            case "ArrowLeft":
              movePlayer("left");
              break;
            case "ArrowRight":
              movePlayer("right");
              break;
            case "i":
            case "I":
              handleActionButton(() => toggleInventory(true));
              break;
            case "Escape":
              handleActionButton(() => toggleInventory(false));
              break;
          }
        }
      });

      // Fungsi untuk eksplorasi atau masuk ke kota
      function exploreOrEnterCity() {
        const char = gameState.selectedCharacter;
        const charAttrs = characters[char];

        // Base happiness cost
        let happinessCost = -15;

        // Apply character weakness/strength to happiness cost
        if (charAttrs) {
          if (charAttrs.weakness && charAttrs.weakness.happiness) {
            // For Dimsum: calculate the actual cost with weakness
            if (char === "Dimsum") {
              happinessCost = Math.round(happinessCost * 1.3); // 30% more penalty
              // Check if this would reduce happiness to 0 or below for Dimsum
              if (gameState.playerStats.happiness + happinessCost <= 0) {
                addLogEntry(
                  "Kelemahan Dimsum membuat kamu tidak bisa explorasi, Pergi ke rumah dan main game untuk meningkatkan happiness!"
                );
                return;
              }
            }
          } else if (charAttrs.strength && charAttrs.strength.happiness) {
            happinessCost = Math.round(happinessCost * 0.7);
          }
        }

        // Check if the change would kill the character (for non-Dimsum characters)
        if (gameState.playerStats.happiness + happinessCost <= 0) {
          addLogEntry("Happiness terlalu rendah untuk melakukan perjalanan!");
          return;
        }

        // Apply happiness cost
        const actualChange = updateStats("happiness", happinessCost);

        // Lokasi spesial
        const specialLocations = [
          { name: "HOME", x: 1, y: 1, file: "Home.html" },
          { name: "JAKARTA", x: 6, y: 1, file: "Jakarta.html" },
          { name: "PADANG", x: 1, y: 6, file: "Padang.html" },
          { name: "MAGELANG", x: 6, y: 6, file: "Magelang.html" },
          { name: "PAPUA", x: 3, y: 3, file: "Papua.html" },
        ];

        const playerX = gameState.playerPosition.x;
        const playerY = gameState.playerPosition.y;

        const specialLocation = specialLocations.find(
          (loc) => loc.x === playerX && loc.y === playerY
        );

        if (specialLocation) {
          // Masuk lokasi spesial
          let message = `Anda menjelajahi ${specialLocation.name}... (Happiness ${actualChange})`;
          if (char === "Dimsum") {
            message += " (Efek: Happiness berkurang lebih banyak)";
          } else if (char === "Revlog" || char === "Robert") {
            message += " (Efek: Happiness berkurang lebih sedikit)";
          }
          addLogEntry(message);

          // Simpan state sebelum pindah halaman
          saveGameState();

          // Langsung redirect ke halaman lokasi
          window.location.href = specialLocation.file;
        } else {
          // Eksplorasi biasa
          addLogEntry("Anda menjelajahi area sekitar...");

          // Random efek eksplorasi
          const result = Math.random();
          if (result < 0.3) {
            // Temukan koin
            const coins = Math.floor(Math.random() * 15) + 5;
            gameState.playerStats.money += coins;
            addLogEntry(`Anda menemukan ${coins} koin!`);
            updateStatusDisplay();
          } else if (result < 0.6) {
            // Tidak menemukan apa-apa
            addLogEntry("Tidak ada yang menarik di sekitar sini.");
          } else {
            // Kebahagiaan
            updateStats("happiness", 15);
            addLogEntry(
              "Pemandangan indah membuat Anda bahagia! (+15 Happiness)"
            );
          }
        }
      }

      // Fungsi untuk mengecek stat rendah
      function checkLowStats() {
        // Hunger warnings
        if (gameState.playerStats.hunger <= 50) {
          const urgency =
            gameState.playerStats.hunger <= 30
              ? "üî•üî•üî• KRITIS!"
              : "üî• Warning!";
          addLogEntry(
            `${urgency} Hunger: ${gameState.playerStats.hunger}/100 - ${
              gameState.playerStats.hunger <= 30
                ? "Cari makanan segera!"
                : "Anda merasa lapar"
            }`
          );

          // Visual feedback for critical
          if (gameState.playerStats.hunger <= 30) {
            document.querySelector(".stat-fill.hunger").style.animation =
              "pulse-red 0.8s infinite";
          }
        }

        // Sleep warnings
        if (gameState.playerStats.sleep <= 50) {
          const urgency =
            gameState.playerStats.sleep <= 30
              ? "üí§üí§üí§ KRITIS!"
              : "üí§ Warning!";
          addLogEntry(
            `${urgency} Sleep: ${gameState.playerStats.sleep}/100 - ${
              gameState.playerStats.sleep <= 30
                ? "Istirahat sekarang!"
                : "Anda mengantuk"
            }`
          );

          if (gameState.playerStats.sleep <= 30) {
            document.querySelector(".stat-fill.sleep").style.animation =
              "pulse-yellow 0.8s infinite";
          }
        }

        // Hygiene warnings
        if (gameState.playerStats.hygiene <= 50) {
          const urgency =
            gameState.playerStats.hygiene <= 30
              ? "üíßüíßüíß KRITIS!"
              : "üíß Warning!";
          addLogEntry(
            `${urgency} Hygiene: ${gameState.playerStats.hygiene}/100 - ${
              gameState.playerStats.hygiene <= 30
                ? "Bersihkan diri segera!"
                : "Anda merasa kotor"
            }`
          );

          if (gameState.playerStats.hygiene <= 30) {
            document.querySelector(".stat-fill.hygiene").style.animation =
              "pulse-blue 0.8s infinite";
          }
        }

        // Happiness warnings
        if (gameState.playerStats.happiness <= 50) {
          const urgency =
            gameState.playerStats.happiness <= 30
              ? "üíîüíîüíî KRITIS!"
              : "üíî Warning!";
          addLogEntry(
            `${urgency} Happiness: ${gameState.playerStats.happiness}/100 - ${
              gameState.playerStats.happiness <= 30
                ? "Lakukan sesuatu yang menyenangkan!"
                : "Anda merasa tidak bahagia"
            }`
          );

          if (gameState.playerStats.happiness <= 30) {
            document.querySelector(".stat-fill.happiness").style.animation =
              "pulse-green 0.8s infinite";
          }
        }
      }

      // Start the game when the page loads
      window.onload = initGame;

      // Keep only one window.onload extension
      const originalOnload = window.onload;
      window.onload = function () {
        // Run the original onload function if it exists
        if (typeof originalOnload === "function") {
          originalOnload();
        }

        // Add our additional setup
        setupActionButtons();
      };

      function shower() {
        const char = gameState.selectedCharacter;
        const charAttrs = characters[char];

        // Base values
        let hygieneGain = 100 - gameState.playerStats.hygiene; // Fill to max

        // Apply character-specific modifiers
        if (charAttrs && charAttrs.strength && charAttrs.strength.hygiene) {
          hygieneGain = Math.round(hygieneGain * charAttrs.strength.hygiene);
        }

        // Apply changes
        const actualGain = updateStats("hygiene", hygieneGain);

        let message = `Anda mandi. Hygiene +${actualGain}`;
        if (char === "Sam") message += " (30% lebih efektif)";

        addLogEntry(message);
        updateStatusDisplay();
      }

      function eat() {
        const char = gameState.selectedCharacter;
        const charAttrs = characters[char];

        // Base cost is 20 coins
        let cost = 20;

        // Apply Dimsum's discount if he's the selected character
        if (
          char === "Dimsum" &&
          charAttrs &&
          charAttrs.strength &&
          charAttrs.strength.money
        ) {
          cost = Math.round(cost * charAttrs.strength.money);
        }

        if (gameState.playerStats.money >= cost) {
          // Kurangi uang
          gameState.playerStats.money -= cost;

          // Tambah hunger
          updateStats("hunger", 35);

          // Tampilkan pesan
          let message = `Anda makan makanan lezat. Hunger +35 (Biaya: ${cost} koin)`;
          if (char === "Dimsum") {
            message += " (20% diskon)";
          }
          addLogEntry(message);

          // Update tampilan
          updateStatusDisplay();
        } else {
          addLogEntry("Uang tidak cukup untuk makan!");
        }
      }

      function work() {
        const char = gameState.selectedCharacter;
        const charAttrs = characters[char];

        // Check requirements
        if (
          gameState.playerStats.sleep < 20 ||
          gameState.playerStats.hunger < 20
        ) {
          addLogEntry("Terlalu lelah atau lapar untuk bekerja!");
          return;
        }

        // Base earnings and costs
        let baseEarn = Math.floor(Math.random() * 101) + 50; // 50-150
        let sleepCost = -20;
        let hungerCost = -20;
        let hygieneCost = -35;

        // Apply character modifiers
        if (charAttrs) {
          // Sam earns more
          if (charAttrs.strength && charAttrs.strength.money) {
            baseEarn = Math.round(baseEarn * charAttrs.strength.money);
          }
          // Robert and Revlog get hungrier faster
          if (charAttrs.weakness && charAttrs.weakness.hunger) {
            hungerCost = Math.round(hungerCost * charAttrs.weakness.hunger);
          }
          // Robert and Sam lose sleep faster
          if (charAttrs.weakness && charAttrs.weakness.sleep) {
            sleepCost = Math.round(sleepCost * charAttrs.weakness.sleep);
          }
        }

        // Apply changes
        gameState.playerStats.money += baseEarn;
        const actualSleepCost = updateStats("sleep", sleepCost);
        const actualHungerCost = updateStats("hunger", hungerCost);
        const actualHygieneCost = updateStats("hygiene", hygieneCost);

        let message = `Anda bekerja. Mendapatkan ${baseEarn} koin`;
        if (char === "Sam") message += " (50% lebih banyak)";
        message += `. Sleep ${actualSleepCost}, Hunger ${actualHungerCost}, Hygiene ${actualHygieneCost}.`;

        addLogEntry(message);
      }

      function sleep() {
        const char = gameState.selectedCharacter;
        const charAttrs = characters[char];

        // Calculate sleep needed to reach max
        const sleepNeeded =
          gameState.playerStats.maxSleep - gameState.playerStats.sleep;

        // Apply Revlog's faster recovery if applicable
        let sleepGain = sleepNeeded;
        if (charAttrs && charAttrs.strength && charAttrs.strength.sleep) {
          sleepGain = Math.round(sleepNeeded * charAttrs.strength.sleep);
        }

        // Apply the sleep
        updateStats("sleep", sleepGain);

        let message = `Anda tidur. Sleep +${sleepGain}`;
        if (char === "Revlog") message += " (Pemulihan 20% lebih cepat)";

        // Apply Robert's sleep penalty
        if (
          char === "Robert" &&
          charAttrs &&
          charAttrs.special &&
          charAttrs.special.sleepPenalty
        ) {
          const penalty = charAttrs.special.sleepPenalty;
          gameState.playerStats.money = Math.max(
            0,
            gameState.playerStats.money - penalty
          );
          message += `\nRobert kehilangan ${penalty} koin karena tertidur!`;
        }

        addLogEntry(message);
        updateStatusDisplay();
      }

      // Fungsi untuk membuat tooltips
      function setupTooltips() {
        const infoIcons = document.querySelectorAll(".info-icon");
        infoIcons.forEach((icon) => {
          // Hapus popup lama jika ada
          const oldPopup = icon.querySelector(".info-popup");
          if (oldPopup) {
            oldPopup.remove();
          }

          // Buat popup baru
          const popup = document.createElement("div");
          popup.className = "info-popup";
          popup.textContent = icon.getAttribute("data-tooltip");
          icon.appendChild(popup);
        });
      }

      // Panggil setupTooltips saat DOM loaded
      document.addEventListener("DOMContentLoaded", function () {
        setupTooltips();

        // Re-setup tooltips setiap kali tombol aksi diperbarui
        const observer = new MutationObserver(function (mutations) {
          mutations.forEach(function (mutation) {
            if (mutation.addedNodes.length) {
              setupTooltips();
            }
          });
        });

        // Observe changes in action-panel
        const actionPanel = document.querySelector(".action-panel");
        if (actionPanel) {
          observer.observe(actionPanel, { childList: true, subtree: true });
        }

        // Update the explore button tooltip when DOM is loaded
        const exploreButton = document.querySelector(".action-button.explore");
        if (exploreButton) {
          const infoIcon = exploreButton.querySelector(".info-icon");
          if (infoIcon) {
            infoIcon.setAttribute("data-tooltip", "Cost: -15 Happiness");
          }
        }
      });

      // Add the playGames function
      function playGames() {
        const char = gameState.selectedCharacter;
        const charAttrs = characters[char];

        // Base values
        let happinessGain = 50;
        let sleepCost = -25;

        // Apply character modifiers
        if (charAttrs) {
          // Apply happiness modifiers
          if (charAttrs.strength && charAttrs.strength.happiness) {
            happinessGain = Math.round(
              happinessGain * charAttrs.strength.happiness
            );
          } else if (charAttrs.weakness && charAttrs.weakness.happiness) {
            happinessGain = Math.round(
              happinessGain * charAttrs.weakness.happiness
            );
          }

          // Apply sleep modifiers
          if (charAttrs.weakness && charAttrs.weakness.sleep) {
            sleepCost = Math.round(sleepCost * charAttrs.weakness.sleep);
          }
        }

        // Check if sleep would go too low
        if (gameState.playerStats.sleep + sleepCost <= 0) {
          addLogEntry("Sleep terlalu rendah untuk bermain game!");
          return;
        }

        // Apply the changes
        const actualHappinessGain = updateStats("happiness", happinessGain);
        const actualSleepCost = updateStats("sleep", sleepCost);

        // Create message based on character
        let message = `Anda bermain video game. Happiness +${actualHappinessGain}, Sleep ${actualSleepCost}`;

        if (char === "Dimsum") {
          message += " (Efek: Happiness berkurang karena weakness)";
        } else if (char === "Revlog" || char === "Robert") {
          message += " (Efek: Happiness bertambah karena strength)";
        }

        if (char === "Sam" || char === "Robert") {
          message += " (Efek: Sleep berkurang lebih cepat)";
        }

        addLogEntry(message);
        updateStatusDisplay();
      }
    </script>
    <div id="inventory-panel" class="inventory-panel">
      <h2>Inventaris</h2>
      <div id="inventory-grid" class="inventory-grid"></div>
      <button class="close-inventory" onclick="toggleInventory(false)">
        Tutup
      </button>
    </div>
  </body>
</html>
